\chapter{地下探测FDTD仿真技术研究}
本章的主要是内容是探地雷达应用到地下目标探测时的仿真技术。在将深度学习相关技术，特别是深度卷积神经网络
技术应用到探地雷达地下目标识别时需要提供大量的训练与测试数据用于神经网络的性能调优、结构调整、参数选择等等
过程。由于电磁仿真所得的数据具有目标位置明确模型参数已知的特点，在进行神经网络建模时就有了明确的参考
依据，可以验证网络的预测正确性和性能。另外，数值仿真也有数据获取简单，能用批量得到不同目标参数的B扫数据的特点。
因此，在将深度学习技术应用到实际实验数据之前，先在大量仿真数据上进行
初始研究是有重要意义的，这将为后面的工作提供良好的准备。

目前在探地雷达数值仿真领域，由于其原理简单、容易并行加速的特点，最常用的且最成熟的方法为时域有限差分（FDTD）法（引用）。
常见的探地雷达数值仿真计算为了模型简便，通常采用简单几何模型、均匀介质、点源等近似方法，在普通应用时通常也能带来令人
足够满意的效果。
但是，由于本文进行探地雷达数值仿真的目的是为深度学习目标识别技术的研究提供训练数据，需要仿真所得的数据尽量接近实际数据的特点，
这样才能对网络的实际性能做可信的评判，如果仿真模型过于理想化则生成的B扫数据会具有明显的目标特征而在非目标位置呈现干净的
图像从而与实际实验中复杂的土壤和仪器环境所带来的诸多干扰和虚假目标不相吻合。具体来说，笔者在应用这些常规方法建模并进行数值仿真时发现
以下几个问题：
\begin{figure}[htbp]
	\includegraphics[width=0.8\textwidth]{soil_profile.png}
	\caption{某地土壤切面图（资料来自美国农业部官网）}
	\label{soil_profile}
\end{figure}

1. 简单几何模型不能模拟土壤表面复杂的起伏特征。如图\ref{soil_profile}所示，真实土壤表面呈现凹凸不平的起伏特征，这将会在雷达回波中
引入相当程度的抖动等干扰，而常规仿真方法中使用的标准长方体模型的边界是完美的平面，不能代表实际土壤的形态。所以需要研究土壤表面起伏
的数据特征并构想相关的模型生成算法。

2. 均匀介质模型不能模拟土壤中介质的随机分布特征。观察图\ref{soil_profile}中的土壤剖面可看到不均匀的土壤颗粒分布特征，土壤中介质
的不均匀分布必将导致雷达波传播过程中的路径和散射特征的改变，从来对雷达B扫图像引起干扰。常规方法中所使用的均匀介质，除了在不同介质的
相交面这样的介质参数突变的位置，对雷达波不会产生任何扭曲和路径改变，产生的数据过于理想化。因此需要研究土壤介质的构成模型和分布特点
并提供相应的建模算法以模拟真实土壤的介质形态。

3. 点源模型不能模拟近场状态时天线的传输特征。常规仿真方法通常将探地雷达天线近似为单个网格的点源模型，但是由于本文所研究的目标识别问题
中目标和天线的距离较近，且该距离接近天线的工作频率波长，因此此时天线的传输特征对雷达B扫图像将产生可见的影响，不符合尽量获取拟真数据
的目标，因此继续使用常规方法中的点源模型将不是理想的选择。

本章主要内容安排为：1. 介绍FDTD仿真的基本原理和开源数值仿真平台gprMax；2. 针对模拟土壤表面复杂起伏特征和介质随机
分布特征的问题，基于土壤介质参数半经验模型和FFT分形数据生成算法形成真实土壤模型构建算法；3. 针对模拟天线传输特征的问题，
研究将真实天线几何模型内置到FDTD网格的方法。4. 综合前面几节的结果，批量得到拟真雷达B扫图像。
\section{仿真方法与计算平台}
常用的电磁仿真方法有矩量法、有限元法和FDTD法。其中有限元法的理论基础是变分和插值，适用于求解各类微分方程问题，特别是物理场的求解问题；
矩量法的求解目标是代数方程组，这些方程组由待求解积分或微分方程转化而来；FDTD法以差分原理为基础，将麦克斯韦方程中的微分算子通过差分近似。
FDTD法具有容易掌握，直观简洁的特点，其计算迭代方程可由麦克斯韦方程直接导出而且不需要进行其他复杂的推导过程，另外由于其将空间划分为均匀的
立方体网格，所以也特别适合复杂模型的程序化生成，特别是本章要解决的土壤与天线建模问题。
\subsection{FDTD方法基本原理}
\begin{figure}[htbp]
	\includegraphics{yee_cube.pdf}
	\caption{FDTD网格示意图}
	\label{yee_cube}
\end{figure}

FDTD法的基本思想是将计算空间离散为一个一个的矩形网格（图\ref{yee_cube}），然后再将磁场与电场矢量分布到这些网格上，其中磁场位于每个立方体各个面的重心处且
垂直于该表面，电常位于各条边中心且与其平行。将$\mathbf{E}_x$、$\mathbf{E}_y$、$\mathbf{E}_z$、
$\mathbf{H}_x$、$\mathbf{H}_y$、$\mathbf{H}_z$六个分量以Maxwell方程组联系起来，即可得到：
\begin{equation} 
\varepsilon \frac{\partial E_{x}}{\partial t}=\frac{\partial H_{z}}{\partial y}-\frac{\partial H_{y}}{\partial z}-\sigma E_{x}
\label{eqn:maxwell_1} 
\end{equation}
 \begin{equation} 
 \varepsilon \frac{\partial E_{y}}{\partial t}=\frac{\partial H_{x}}{\partial z}-\frac{\partial H_{z}}{\partial x}-\sigma E_{y}
  \end{equation}
  \begin{equation} 
  \varepsilon \frac{\partial E_{z}}{\partial t}=\frac{\partial H_{y}}{\partial x}-\frac{\partial H_{x}}{\partial y}-\sigma E_{z}
   \end{equation}
   \begin{equation} 
\mu \frac{\partial H_{x}}{\partial t}=\frac{\partial E_{y}}{\partial z}-\frac{\partial E_{z}}{\partial y}
 \end{equation}
 \begin{equation} 
\mu \frac{\partial H_{y}}{\partial t}=\frac{\partial E_{z}}{\partial x}-\frac{\partial E_{x}}{\partial z}
 \end{equation}
 \begin{equation} 
	\label{eqn:maxwell_6}
\mu \frac{\partial H_{z}}{\partial t}=\frac{\partial E_{x}}{\partial y}-\frac{\partial E_{y}}{\partial x}
 \end{equation}

 以上6个分量均可由对于三个空间方向以及时间方向的偏导数，也就是对于$x, y, z, t$的偏导数都可以以下中心差分公式
 近似表示：
 \begin{equation} 
 \frac{\partial f(\xi)}{\partial \xi}=\frac{\partial f(\xi+\Delta \xi / 2)}{\partial \xi}-\frac{\partial f(\xi-\Delta \xi / 2)}{\partial \xi}
  \end{equation}

代入式\ref{eqn:maxwell_1} \textasciitilde \ref{eqn:maxwell_6}即可得到Maxwell方程的离散形式：
\begin{equation} 
\begin{array}{l}{E_{x}^{n+1}\left(i+\frac{1}{2}, j, k\right)=\left(\frac{2 \varepsilon-\sigma \Delta t}{2 \varepsilon+\sigma \Delta t}\right) E_{x}^{n}\left(i+\frac{1}{2}, j, k\right)+\left(\frac{2 \Delta t}{2 \varepsilon+\sigma \Delta t}\right)\{ } \\ {\frac{1}{\Delta y}\left[H_{z}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j+\frac{1}{2}, k\right)-H_{z}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j-\frac{1}{2}, k\right)\right]-} \\ {\frac{1}{\Delta z}\left[H_{y}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j, k+\frac{1}{2}\right)-H_{y}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j, k-\frac{1}{2}\right)\right]}\end{array}
 \end{equation}
 \begin{equation} 
\begin{array}{l}{E_{y}^{n+1}\left(i, j+\frac{1}{2}, k\right)=\left(\frac{2 \varepsilon-\sigma \Delta t}{2 \varepsilon+\sigma \Delta t}\right) E_{y}^{n}\left(i, j+\frac{1}{2}, k\right)+\left(\frac{2 \Delta t}{2 \varepsilon+\sigma \Delta t}\right)\{ } \\ {\frac{1}{\Delta z}\left[H_{x}^{n+\frac{1}{2}}\left(i, j+\frac{1}{2}, k+\frac{1}{2}\right)-H_{x}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j, k-\frac{1}{2}\right)\right]-} \\ {\frac{1}{\Delta x}\left[H_{z}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j+\frac{1}{2}, k\right)-H_{z}^{n+\frac{1}{2}}\left(i-\frac{1}{2}, j+\frac{1}{2}, k\right)\right]}\end{array}
 \end{equation}
 \begin{equation} 
\begin{array}{l}{E_{z}^{n+1}\left(i, j, k+\frac{1}{2}\right)=\left(\frac{2 \varepsilon-\sigma \Delta t}{2 \varepsilon+\sigma \Delta t}\right) E_{z}^{n}\left(i, j+\frac{1}{2}, k\right)+\left(\frac{2 \Delta t}{2 \varepsilon+\sigma \Delta t}\right)\{ } \\ {\frac{1}{\Delta x}\left[H_{y}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j, k+\frac{1}{2}\right)-H_{y}^{n+\frac{1}{2}}\left(i-\frac{1}{2}, j, k+\frac{1}{2}\right)\right]-} \\ {\frac{1}{\Delta y}\left[H_{x}^{n+\frac{1}{2}}\left(i, j+\frac{1}{2}, k+\frac{1}{2}\right)-H_{x}^{n+\frac{1}{2}}\left(i, j-\frac{1}{2}, k+\frac{1}{2}\right)\right]}\end{array}
 \end{equation}
 \begin{equation} 
\begin{array}{l}{H_{x}^{n+\frac{1}{2}}\left(i, j+\frac{1}{2}, k+\frac{1}{2}\right)=\left(\frac{2 \mu-\sigma \Delta t}{2 \mu+\sigma \Delta t}\right) H_{x}^{n-\frac{1}{2}}\left(i, j+\frac{1}{2}, k+\frac{1}{2}\right)-} \\ {\left(\frac{2 \Delta t}{2 \mu+\sigma \Delta t}\right)\left\{\frac{1}{\Delta y}\left[E_{z}^{n}\left(i, j+1, k+\frac{1}{2}\right)-E_{z}^{n}\left(i, j, k+\frac{1}{2}\right)\right]-\right.} \\ {\frac{1}{\Delta z}\left[E_{y}^{n}\left(i, j+\frac{1}{2}, k+1\right)-E_{y}^{n}\left(i, j+\frac{1}{2}, k\right)\right]}\end{array}
 \end{equation}
 \begin{equation} 
\begin{array}{l}{H_{y}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j, k+\frac{1}{2}\right)=\left(\frac{2 \mu-\sigma \Delta t}{2 \mu+\sigma \Delta t}\right) H_{y}^{n-\frac{1}{2}}\left(i+\frac{1}{2}, j, k+\frac{1}{2}\right)-} \\ {\left(\frac{2 \Delta t}{2 \mu+\sigma \Delta t}\right)\left\{\frac{1}{\Delta z}\left[E_{x}^{n}\left(i+\frac{1}{2}, j, k+1\right)-E_{z}^{n}\left(i+\frac{1}{2}, j, k\right)\right]-\right.} \\ {\frac{1}{\Delta x}\left[E_{z}^{n}\left(i+1, j, k+\frac{1}{2}\right)-E_{z}^{n}\left(i, j, k+\frac{1}{2}\right)\right]}\end{array}
 \end{equation}
 \begin{equation} 
\begin{array}{l}{H_{z}^{n+\frac{1}{2}}\left(i+\frac{1}{2}, j+\frac{1}{2}, k\right)=\left(\frac{2 \mu-\sigma \Delta t}{2 \mu+\sigma \Delta t}\right) H_{z}^{n-\frac{1}{2}}\left(i+\frac{1}{2}, j+\frac{1}{2}, k\right)-} \\ {\left(\frac{2 \Delta t}{2 \mu+\sigma \Delta t}\right)\left\{\frac{1}{\Delta x}\left[E_{y}^{n}\left(i+1, j+\frac{1}{2}, k\right)-E_{z}^{n}\left(i, j+\frac{1}{2}, k\right)\right]-\right.} \\ {\frac{1}{\Delta y}\left[E_{x}^{n}\left(i+\frac{1}{2}, j+1, k\right)-E_{x}^{n}\left(i+\frac{1}{2}, j, k\right)\right]}\end{array}
 \end{equation}

通过以上各式，在$t_0$时刻已知当前空间所有网格电场值的情况下，便可推得$t_0+{\Delta t}/2$时刻所有网格的磁场值，
再次步进${\Delta t}/2$时刻即又能得到$t_0+\Delta t$时刻的电场值。如此循环往复即可进行电磁波在自由空间与介质中
随时间传播的数值模拟结果。以上是FDTD方法的时间步进基本过程，关于其数值稳定性、误差分析和边界条件等细节在此便不再赘述。
\subsection{gprMax仿真平台}
通过上节的原理很容易自行编写可用的FDTD数值计算程序。笔者曾编写过基于C++与Matlab的三维FDTD仿真软件，两种程序均存在
一些难以克服的缺点。Matlab版由于Matlab强大的工程计算函数库和友好的界面很容易进行快速建模与结果可视化，但是其计算缓慢
，即使使用内置的并行接口其速度也难以达到本文的计算量需求。C语言版可生成高效原生代码，并且可借助并行计算程序包OpenMP在
实验室数值计算服务器上利用多核CPU的优势得到更快的计算速度。但是相对于Matlab版，C语言版却缺乏足够的灵活性，在复杂形体建模
方面需要书写大量的底层逻辑甚至需要用到专业的计算几何知识，此外C语言在数据的可视化方面也缺乏足够的工具，往往还是需要
借助其他工具进行数据处理。考虑到这些因素，本文采用英国爱丁堡大学团队开发的开源电磁仿真程序包gprMax
\citing{giannopoulos2005modelling, warren2016gprmax}作为FDTD计算引擎，并
利用其开源的优势进行大量的二次开发以满足本文中建模仿真的需要。

结合本文所研究问题的实际特点，gprMax 与C、Matlab以及其他常见商业软件相比以下显著优势：

计算速度快。最新版gprMax采用python语言开发，python作为一门脚本语言本身运行效率并不高，但是却可因为其胶水语言的特性
克服这一缺点。其主要加速途径主要有三方面：1. 可以对gprMax源码进行研究可发现内部其使用了Cython程序包。
Cython程序包可将普通的Python语句编译到C语言，从而解决解释性语言运行速度慢的问题。2. FDTD时间步进方程在计算时每个网格
场值只与上一时刻的场值有关，每个网格的计算是互相独立，因此可将计算空间划分为多个区域，并将每个区域分配给单独的CPU核心计算。
另外，在同时仿真多个模型时，还可以利用MPI调度集群内的多个CPU同时计算并汇总计算结果。3. 最新版本的gprMax开始支持基于英伟达
CUDA平台的GPU加速\citing{warren2019cuda}，实测利用显卡的多核心矩阵运算能力可将计算时间缩短到之前的四十分之一左右。

极强的可扩展性。gprMax 的扩展能力使得用户可以很方便的定义属于自己的模型库和脚本化控制仿真的运行，特别适合需要建立复杂模型
与大量仿真的情形。在阅读其源码后也可以对内部计算流程进行修改和补充，比如改变仿真结果的保存格式。gprMax的扩展能力一方面来自于
其开源的特点，即所有代码可供用户阅读与修改，另一方面由于python语言在运行时不需要编译，用户所作的修改和自定义库可以和原有gprMax
程序无缝融合而不需要传统软件工程的构建流程，方便了使用者的自定义流程。

本章后面小节的建模与仿真充分利用了这两个优势。首先土壤天线建模和补充均以python用户模块的形式增强gprMax原有的功能。其次
仿真时均利用实验室高性能显卡实现了显著加速。

\section{拟真土壤模型}
本节所介绍的拟真土壤模型由两方面的理论组成，其一是土壤混合物的电磁参数模型，其二是地下介质分布和地形所蕴含的分形特征。
\subsection{拟真土壤模型原理}
1995年，Peplinski 等人提出一种模拟真实土壤电磁特性的半经验模型\citing{peplinski1995dielectric}。在此模型中，土壤由三种成分构成，分别是：
颗粒直径在0.05mm到2.0mm之间的沙土，颗粒直径在0.002mm到0.05mm之间的粉土，以及颗粒直径在0.002
以下的粘土。这三种成分的配比不同可表示不同的土壤类型，进而也影响到其电磁特性。同时，土壤中含水量也对
其电磁特性起重大影响。综合这些因素，土壤的复介电常数$\epsilon_m$由式\ref{eqn:peplinskiall}给出。
\begin{equation} 
	\label{eqn:peplinskiall} 
	\begin{aligned} \epsilon_{m} &=\epsilon_{m}^{\prime}-j \epsilon_{m}^{\prime \prime} \\ 
\epsilon_{m}^{\prime} &=1.15 \left[1+\frac{\rho_{b}}{\rho_{s}}\left(\epsilon_{s}^{\alpha}\right)+m_{v}^{\beta^{\prime}} \epsilon_{f w}^{\alpha}-m_{v}\right]^{1 / \alpha} - 0.68\\ 
\epsilon_{m}^{\prime \prime} &=\left[m_{v}^{\beta^{\prime \prime}} \epsilon_{f w}^{\prime \prime \alpha}\right]^{1 / \alpha} \end{aligned}
\end{equation}

上式中，$\epsilon_{m}^{\prime}$ 与 $\epsilon_{m}^{\prime}$分别是复介电常数
$\epsilon_m$的实部与虚部；$\rho_{b}$ 与 $\rho_{s}$分别是土壤的总密度和其中沙土成分
的密度（单位：$g/cm^3$）;$\beta^\prime$与$\beta^{\prime \prime}$分别是与土壤构成
相关的常数，其表达式为\ref{eqn:soil_beta}，其中$S$与$C$分别是沙土与粘土的构成比例
（$0<S<1, 0<C<1$）。
\begin{equation} 
	\label{eqn:soil_beta}
	\begin{aligned}
\beta^{\prime}&=1.2748-0.519 S-0.152 C \\
\beta^{\prime \prime}&=1.33797-0.603 S-0.166 C
	\end{aligned}
\end{equation}

式\ref{eqn:peplinskiall}中$\epsilon_{f w}^{\prime}$与$\epsilon_{f w}^{\prime \prime}$
分别是土壤中自由水的实部与虚部，其表达式由式\ref{eqn:soil_water}给出。
\begin{equation} 
	\label{eqn:soil_water}
	\begin{aligned}
		\epsilon_{f w}^{\prime}&=\epsilon_{w \infty}+\frac{\epsilon_{w 0}-\epsilon_{w \infty}}{1+\left(2 \pi f \tau_{w}\right)^{2}} \\
		\epsilon_{f w}^{\prime \prime}&=\frac{2 \pi f \tau_{w}\left(\epsilon_{w 0}-\epsilon_{w \infty}\right)}{1+\left(2 \pi f \tau_{w}\right)^{2}}+\frac{\sigma_{\mathrm{eff}}}{2 \pi \epsilon_{0} f} \frac{\left(\rho_{s}-\rho_{b}\right)}{\rho_{s} m_{v}}
	\end{aligned}
\end{equation}
其中，$\epsilon_{w \infty}$是$\epsilon_{f w}^{\prime}$在高频时的极限；$\tau_{w}$为自由水的
弛豫时间常数；$\epsilon_{w 0}$为水的静态相对介电常数，其值为80.1；$\sigma_{\mathrm{eff}}$为有效电导率
，由经验公式\ref{eqn:soil_eff}给出。
\begin{equation}
	\label{eqn:soil_eff}
\sigma_{\mathrm{eff}}=0.0467+0.2204 \rho_{b}-0.4111 S+0.6614 C
\end{equation}

以上便是拟真土壤模型的基本原理，下面讨论如何将此模型应用到探地雷达FDTD仿真中。
按照式\ref{eqn:peplinskiall}，在给定土壤构成比例$S$与$C$后，该土壤类型的电磁参量主要由含水量决定。
实际土壤中含水量的分布不是均匀的，因此可定义含水量的最小值与最大值分别为$m_{vmin}$与$m_{vmax}$。
将此含水量范围等距离取$n$个点并代入式\ref{eqn:peplinskiall}便可得到一系列复介电常数
$\epsilon_i(i=1,2,3...n)$ 

得到组成土壤的介质列表之后，接下来了的问题便是考虑这些介质应该如何分布在FDTD三维网格中。文献
\cite{turcotte1997fractals}
指出地下空间内孔隙度含水量等特性的分布并不是完全随机的而是呈随机分形特征。因此可以利用分形生成算法安排前面得到的一系列介质在FDTD网格
中的分布从而达到对真实土壤较好的模拟效果。

分形在数学中是一种抽象的物体，用于描述自然界中存在的事物。人工分形通常在放大后能展现出相似的形状。 
分形也被称为扩展对称或展开对称。如果在每次放大后，
形状的重复是完全相同的，这被称为自相似。分形在不同的缩放级别上可以是近似相似的。 
分形也包有图像的细节重复自身的意味。一种效率较高的分形数据生成算法是以离散傅里叶变换为基础的。
其算法理论基础是具有分形特征的数据的离散傅里叶变换（DFT）上各频率
的系数$m_f$与频率$f$近似呈幂律关系，即：
\begin{equation}
m_f = \frac{C}{f^{\frac{-(2 D-7)}{2}}}
\end{equation}
其中$D$为分形维度，其值在1到3之间。

因此，可以用以下步骤生成生成复介电常数列表在土壤所在三维空间内FDTD网格的分形分布：

1. 对于尺寸为$x,y,z$的FDTD网格区域，生成相同大小的随机三维数据$\mathbf{A}$。

2. 对$\mathbf{A}$应用三维快速傅里叶变换算法，并将结果进行平移，使零频率处于三维数组
的中心。

3. 设$\mathbf{A}$的中心点的坐标为$(i_c,j_c,k_c)$，对于每一个数据点$\mathbf{A}(i,j,k)$
，计算其与中心点的模，即$L=\sqrt{(i - i_c)^2 + (j - j_c)^2 + (k - j_c)^2}$。

4. 应用公式 $\mathbf{A}(i,j,k) = \mathbf{A}(i,j,k) \frac{1}{L^{\frac{-(2 D-7)}{2}}}$。

5. 对$\mathbf{A}$进行逆傅里叶变换，并将结果归一化并量化为$1$到$n$的整数（对应土壤介质的个数），并在对应位置为FDTD网格的赋予相应
的介质参数。

要获得高度拟真的土壤模型，除了要考虑介质参数分布方面的特征，还要考虑到地形的特征。和土壤介质的分布一样，土壤表面起伏的
形态也符合分形的特征（图\ref{soil_profile}）。

由于同样满足分形特征，土壤起伏表面也可由上述类似的方式生成，比较重要的变化是上面三维的数据变为二维的数据，
空间上的三维傅里叶变换变成平面上的二维傅里叶变换，但是其算法本质不变。其过程可描述为（定义土壤起伏程度为
$k$，分形维数为$D$：

1. 对于尺寸为$x,y$的FDTD网格区域（该区域为需要生成土壤起伏表面的土壤区域顶部所围成的二维区域），
生成相同大小的随机二维数据$\mathbf{A}$。

2. 对$\mathbf{A}$应用二维快速傅里叶变换算法，并将结果进行平移，使零频率处于二维数组
的中心。

3. 设$\mathbf{A}$的中心点的坐标为$(i_c,j_c)$，对于每一个数据点$\mathbf{A}(i,j)$
，计算其与中心点的模，即$L=\sqrt{(i - i_c)^2 + (j - j_c)^2}$。

4. 应用公式 
\begin{equation}
	\label{eqn:fractal_2d}
	\mathbf{A}(i,j) = \mathbf{A}(i,j) \frac{1}{L^{\frac{-(2 D-7)}{2}}}
\end{equation}

5. 对$\mathbf{A}$进行逆傅里叶变换，将所得结果归一化到$[-k,k]$范围内，此时$\mathbf{A}$即代表
土壤区域顶部对应的起伏程度，将此起伏程度数据应用于建模过程便可得到具有起伏表面的土壤模型。
\subsection{建模实例}
为了方便展示计算过程，这里对土壤起伏表面的生成过程做建模演示。图\ref{rough_surface}展示了上述土壤分形生成算法
中各步骤的计算结果，其中第一步中$x$和$y$的值皆为400，分形维数$D=1.5$。图\ref{rough_surface}(a)为原始随机矩阵，
在经过傅里叶变换后变为图\ref{rough_surface}(b)，频域数据经过公式\ref{eqn:fractal_2d}处理后能量集中到
低频区域，这一点可在图\ref{rough_surface}(c)看出来，其中能量由图中心的低频部分像周围的高频区域逐渐下降（图中的
颜色以对数尺度标出）。最后，如图\ref{rough_surface}{d}所示，恢复到时域的数据呈现类似于地形起伏的分形特征。
\begin{figure}[htbp]
	\subfigure[]{
		\label{rough_surface_a}
		\includegraphics{rough_surface_random.pdf}}
	\subfigure[]{
		\label{rough_surface_b}
		\includegraphics{rough_surface_fft.pdf}}
	\subfigure[]{
		\label{rough_surface_c}
		\includegraphics{rough_surface_fft_fractal.pdf}}
	\subfigure[]{
		\label{rough_surface_d}
		\includegraphics{rough_surface_fractal.pdf}
	}
	\caption{土壤起伏表面建模实例二维图。(a)随机二维数据；(b)随机数据的二维傅里叶变换；
	(c)应用公式\ref{eqn:fractal_2d}后的结果；(d)最后生成的土壤起伏数据}
	\label{rough_surface}
\end{figure}

直观起见，图\ref{rough_surface_3d}给出了\ref{rough_surface}(d)中数据的三维曲面图。设该曲面所代表的数据为
$\mathbf{A}_{fractal}$，且其最大值为$A_{max}$最小值为$A_{min}$。在将该结果应用到FDTD建模之前需要对其值的范围进行调整，若指定模型中该土壤表面高度值的
范围为$h_{min}$到$h_{max}$，则可根据下面的公式得出在FDTD模型中的实际表面高度。
\begin{equation}
	\mathbf{A}_{fractal} = \mathbf{A}_{fractal} \frac{h_{max} - h_{min}}{A_{max} - A_{min}} + 
		h_{min} - (\frac{h_{max} - h_{min}}{A_{max} - A_{min}}) h_{min}
\end{equation}
\begin{figure}[htbp]
	\includegraphics[]{rough_surface_fractal_3d.pdf}
	\caption[]{土壤起伏表面建模实例三维图}
	\label{rough_surface_3d}
\end{figure}

按照前述类似的过程也可以建立前述土壤介质分布模型，将此模型与起伏表面模型结合起来便得到完整的拟真土壤模型（图\ref{soil_model_3d}）。


\begin{figure}[htbp]
	\includegraphics[width=0.8\textwidth]{soil_model_3d.png}
	\caption{拟真土壤模型建模示例}
	\label{soil_model_3d}
\end{figure}
\section{天线模型仿真}
探地雷达主要采用偶极子天线、蝶形天线、维瓦尔第天线等几种常用的天线类型。本节讨论FDTD网格中天线建模的方法，并给出建模实例。
\subsection{FDTD天线建模方法}
将天线模型置入FDTD过程中首先要考虑的问题是如何将实际的天线几何模型转化成离散的网格模型。对于结构较为简单的天线来说，如偶极子天线和蝶形天线，
天线的形状可由基本的几何形体构成，而这些基本的几何形体（三角形、矩形、长方体、球、圆柱等）在gprMax中都有对应的建模指令，因此处理起来较为方便，只需要
选择合适的网格尺寸将天线的结构用基本几何体描述出来即可。而对于包含复杂弧度的天线来说，直接用几何体无法拼接出想要的形状。在实践中笔者为了解决
这一问题提出了一套较为实用的解决方案。即先采用图像处理的方法先对天线设计稿进行预处理，标记出天线上金属板的范围。然后，根据FDTD网格尺寸的需要，将处理好的天线金属板图片进行离散化。
最后再次通过图像处理程序将图片中已标记的像素点的位置信息提取出来，然后在FDTD网格模型中使用边长正好等于网格尺寸的矩形板结构依次对应图片中的像素点位置信息。
这样便能将复杂的天线形状完美地移植到FDTD网格中。这一系列步骤将在后面的例子中演示。

其次，还需要考虑仿真过程中信号源加载的问题。在探地雷达实际工作过程中激励信号是由超宽带脉冲信号源产生并通过同轴电缆加载到收发天线的对应端口上。而在
FDTD仿真中，无法做到对信号源以及同轴电缆进行仿真。笔者通过数值实验发现，gprMax中带有内阻的点源可以很好的模拟同轴线端口并将激励信号通过天线金属板
辐射出去。这里还有两方面的问题需要注意。第一点是点源的极化方向需要与实际端口引出的连接到金属板的两个触电的方向一致，这样才能保证信号的传输方式和实际一样。
第二点，因为点源只占一个网格，因此为了让点源的电场同时加载到正负极板上，需要保证正负极板在加载位置只间隔一个网格，这样才不会出现点源与极板之间间隔有
自由空间的情况。

\subsection{仿真实例}
本节以笔者所在团队所设计的维瓦尔第天线\citing{guo2017ultrawideband}为例阐释复杂形状天线的建模过程。图\ref{vivaldi_design}分别给出了此天线的实物图
与设计稿。此天线尺寸为600mm x 450mm x 1mm，两片金属板分别位于基板的正反两面，基板由相对介电常数为3的绝缘材料构成，
馈电位置位于实物图设计稿底部中间位置。

图\ref{vivaldi_model_10mm}为天线设计稿经过图像处理并离散化后的结果，其中离散化的精度为10mm，这是兼顾了仿真精度与
仿真速度的选择。此图片为像素值只有0或1两种可能的二值化图形，因此很容易将其中的白色区域的坐标数据提取出来并将其导入gprMax的
FDTD网格中。

图\ref{vivaldi_fdtd_grid}是该天线金属部分在FDTD网格中的可视化图像。基板正反两面的金属板分别以不同颜色标出，两者所在的平面
相隔一个FDTD网格以便加载信号源。由于所用金属的电阻率很小，天线金属部分的介质设置为PEC（完美电导体）。基板部分按照实际所用
材料的参数将其相对介电常数设置为3。点源位于馈电位置在FDTD网格的对应位置，设置其内阻为$50\Omega$。
\begin{figure}[htbp]
	\subfigure[]{
		\includegraphics[width=0.4\textwidth]{vivaldi_real.png}
	}
	\subfigure[]{
		\includegraphics[width=0.4\textwidth]{vivaldi_design}
	}
	\caption[]{维瓦尔第天线。(a)实物图；(b)设计稿}
	\label{vivaldi_design}
\end{figure}

\begin{figure}[htbp]
	\includegraphics[width=0.8\textwidth]{vivaldi_model_10mm.png}
	\caption[]{维瓦尔第天线几何模型离散化结果（网格尺寸10mm）}
	\label{vivaldi_model_10mm}
\end{figure}

\begin{figure}[htbp]
	\includegraphics[width=0.8\textwidth]{vivaldi_fdtd_grid.png}
	\caption[]{维瓦尔第天线FDTD网格模型}
	\label{vivaldi_fdtd_grid}
\end{figure}

为了检验在FDTD网格中建模的天线的辐射特性在多大程度上符合实际天线的参数，在电源出加载一中心频率为500MHz的高斯脉冲，运行仿真并记录电源处的
场值，由此可计算出此天线的$S_{11}$参数。图\ref{vivaldi_s11_compare}给出了天线$S_{11}$参数的仿真与实测结果对比，其中实测结果由矢量网络分析仪
在微波暗室中测得。可以看出从0.6GHz以下，仿真曲线与实测曲线基本吻合，而这也包括了团队探地雷达的实际工作频率范围。0.6GHz以上与实测曲线出现的
较大偏离的原因是为了提高计算效率FDTD网格的尺寸设置为10mm，从而使波长短的高频部分出现了较大的误差。
\begin{figure}[htbp]
	\includegraphics[]{vivaldi_s11_compare.pdf}
	\caption[]{维瓦尔第天线$S_{11}$曲线比较}
	\label{vivaldi_s11_compare}
\end{figure}

图\ref{vivaldi_propagation}给出了信号源能量在向外传播过程中某时刻的电场值分布图。可以看出天线有明显的方向性，
其辐射能量集中在天线的正前方，这也与天线的设计符合。
\begin{figure}[htbp]
	\includegraphics[width=0.8\textwidth]{vivaldi_propagation.png}
	\caption[]{维瓦尔第天线辐射电场值图}
	\label{vivaldi_propagation}
\end{figure}
\section{B 扫数据的批量生成}
利用gprMax结合前面实现的土壤模型和天线模型可以很方便地完成雷达回波数据的仿真。只需要定义好模型的几何尺寸和介质，信号源的频率和波形，以及
采集时间窗大小，就可以得到一道雷达回波。探地雷达在实际工作时一般会将天线在地面上沿水平移动并且按照一定的时间间隔记录一系列的波形，将这些
回波波形组合起来就可以得到雷达B扫图像。同样，在gprMax里也可以定义天线的移动的方向和间隔还有采集的回波数量，从而得到收发天线在模型内不同
位置的仿真结果，然后得到二维B扫图像。

如前所述，本章的目标是得到一系列的拟真B扫图像以供开发后面深度学习目标识别算法时使用。基于前面小节的内容，本节将介绍批量生成目标介质、位置、
大小和深度随机变化的B扫图像的过程。

gprMax 的建模是以文本形式的配置文件为基础的。在配置文件可以定义与仿真相关的参数，比如时间窗大小，介质参数，目标体大小等等。
配置文件里定义相关参数有命令法和脚本法两种。其中命令法最为基础，只要将相关建模命令的名称和参数直接组合起来
写在一行即可。比如\#domain 10 5 2就定义了整个仿真空间的大小为10x5x2米。脚本法比较灵活，可以通过函数调用
来使用建模命令，同时脚本法内还可以利用python语言控制极其复杂的建模操作，更重要的是命令法中需要手动写入
的参数在脚本法中都可以用变量代替，在修改模型某些几何参数时不用重新人工计算各个几何体的位置参数，
从而在复杂模型的构建时大大减小了出错的可能性。

利用脚本法可以满足构建本章介绍的复杂模型的需要。然而在批量生成仿真数据时，仿真模型内的目标参数在每次仿真时
都会发生变化，仅仅利用脚本法每次只能生成单一的模型。笔者在这里使用一个控制gprMax仿真的调度程序配合配置文件模板
来解决这一问题。配置文件模板和标准的gprMax配置文件格式一致，但是其中在每次仿真时需要随机变化的参数都以占位符
代替。调度程序本身也是一个python脚本，其功能是按照仿真需要生成符合预定范围的目标参数，然后将实际的目标参数
填写到配置文件模板里，最后调度程序将填写好的模板生成对应的配置文件并执行仿真。
这一流程可以用图\ref{gprmax_batch_model_procedure}描述。
\begin{figure}[htbp]
	\includegraphics[]{model_procedure.pdf}
	\caption[]{模型批量生成流程图}
	\label{gprmax_batch_model_procedure}
\end{figure}
\begin{figure}[htbp]
	\includegraphics[]{simu_chart.pdf}
	\caption[]{配置文件模板所对应模型剖面示意图}
	\label{simulation_chart}
\end{figure}

图\ref{simulation_chart}给出了本节所定义的配置文件模板所对应模型的剖面示意图。仿真空间长度为6m，宽度为1.5m，
高度为3m，网格尺寸为0.005m，PML层厚度为0.05m（10个网格）；仿真空间的下半部分为拟真土壤模型，其中沙土与粘土所占
比例都是50\%，密度为$2g/cm^3$，含水量变化范围为0.1\%-2\%；天线离地面高度为0.2m，收发间距0.4m，天线起始位置
离模型的最左边0.5m，天线的移动总距离为4.6m，天线的移动步长为0.02m，总共采集230个位置的数据；信号源的波形为高斯脉冲，
中心频率为200MHz。

前面提到调度程序需要定义目标的参数范围。本文拟对地下目标的材质、位置、尺寸、深度等信息做识别，所以这里需要对
这些参数给定一个范围，让调度程序从中随机选择并生成B扫数据。
表\ref{table_geometry}给出了批量仿真时几何参数
范围；表\ref{table_material}给出了目标体可能的几种介质类型。
\begin{table}[htbp]
	\caption{目标体几何参数范围} 
	\begin{tabular}{|c|c|c|c|} 
		\hline  
		参数 &  最小值 & 最大值 \\
		\hline 
		水平坐标(m) & 2 & 4 \\  
		\hline  
		尺寸(m) & 0.1 & 0.3 \\  
		\hline  
		深度(m) & 0.1 & 0.4 \\  
		\hline  
	\end{tabular}
	\label{table_geometry}
\end{table}

\begin{table}[htbp]
	\caption{目标体介质类型} 
	\begin{tabular}{|c|c|c|c|} 
		\hline  
		介质 &  相对介电常数 & 电导率($S/m$)\\
		\hline 
		金属 & 10 & $10\times10^6$ \\  
		\hline  
		岩石 & 8 & $1\times10^{-6}$ \\  
		\hline  
		水 & 80 & $1\times10^{-6}$ \\  
		\hline  
	\end{tabular}
	\label{table_material}
\end{table}

定义好配置文件模板和调度程序中的参数范围便可以用来批量生成模型和对应的B扫数据。笔者在研究过程中
共自动生成了100个模型和B扫数据。图\ref{model_example}给出了其中两个模型的三维可视化结果。图
\ref{model_example}(a)的中的目标材质为金属，水平位置为3.6m，尺寸为0.18m，深度为0.33m；
图\ref{model_example}(b)的中的目标材质为岩石，水平位置为2.68m，尺寸为0.12m，深度为0.36m。

图\ref{bscan_example}给出了与图\ref{model_example}中的两个模型对应的仿真结果（已经过去背景处理）。
可以看到地面反射由于地面的起伏有较大的抖动。
\begin{figure}[htbp]
	\subfigure[]{
		\includegraphics[width=0.8\textwidth]{model4.png}}
	\subfigure[]{
		\includegraphics[width=0.8\textwidth]{model5.png}
	}
	\caption{随机模型示例}
	\label{model_example}
\end{figure}

\begin{figure}[htbp]
	\subfigure[]{
		\includegraphics[]{bscan4.pdf}}
	\subfigure[]{
		\includegraphics[]{bscan5.pdf}
	}
	\caption{批量生成的B扫示例}
	\label{bscan_example}
\end{figure}
\section{本章小结}
本章介绍了FDTD仿真的基本原理和开源数值仿真平台gprMax并
基于土壤介质参数半经验模型和FFT分形数据生成算法形成真实土
壤模型构建方法；针对模拟天线传输特征的问题，研究将真实天线几何模型内置到FDTD网
格的方法。最后结合配置文件模板和调度程序批量得到拟真雷达B扫图像。